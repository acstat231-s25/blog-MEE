---
title: "text_analysis"
format: html
---


5. Text Analysis

{r}
#| label: stop-words
data(stop_words)

top_junk <- c("news", "said", "people", "mr", "times", "u.s", "including", 
              "justice", "article", "new", "york", "it’s", "don’t", 
              "abortions", "week", "that's", "ms", "supreme", "court", "abortion")

custom_stop <- tibble(word = top_junk)
all_stops <- bind_rows(stop_words, custom_stop)

{r}
#| label: top-words
nyt_meta3 |> 
  unnest_tokens(word, text_clean) |>
  filter(!word %in% all_stops$word, str_detect(word, "^[a-z]+$")) |>
  count(word, sort = TRUE) |>
  slice_max(n, n = 15) |>
  ggplot(aes(n, reorder(word, n))) +
  geom_col(fill = "steelblue") +
  labs(title = "Most Frequent Words", x = "Count", y = "")


{r}
#| label: top-bigrams

nyt_meta3 |> 
  unnest_tokens(bigram, text_clean, token = "ngrams", n = 2) |>
  separate(bigram, c("word1", "word2"), sep = " ") |>
  filter(!word1 %in% all_stops$word, !word2 %in% all_stops$word) |>
  unite(bigram, word1, word2, sep = " ") |>
  count(bigram, sort = TRUE) |>
  slice_max(n, n = 15) |>
  ggplot(aes(n, reorder(bigram, n))) +
  geom_col(fill = "darkorange") +
  labs(title = "Top Bigrams", x = "Count", y = "")


{r}
#| label: afinn

afinn <- get_sentiments("afinn")

# Tokenize and filter
nyt_words <- nyt_meta3 |> 
  unnest_tokens(word, text_clean) |>
  filter(!word %in% all_stops$word)

# Join with AFINN scores
nyt_sentiment <- nyt_words |> 
  left_join(afinn, by = "word")

# Summarize sentiment per article
article_sentiment <- nyt_sentiment |> 
  group_by(title, roe_status, pub_date) |> 
  summarise(sentiment_score = sum(value, na.rm = TRUE), .groups = "drop")


Step 6: Visualizations

{r}
#| label: sentiment-distribution

article_sentiment |> 
  ggplot(aes(x = sentiment_score)) +
  geom_histogram(binwidth = 5, fill = "skyblue") +
  labs(title = "Distribution of NYT Article Sentiment Scores", 
       x = "Sentiment Score", y = "Number of Articles")


{r}
#| label: sentiment-by-roe

ggplot(article_sentiment, aes(x = title, y = sentiment_score, fill = roe_status)) +
  geom_bar(stat = "identity") +
  labs(title = "New York Times Articles Sentiment by Roe Status", 
       x = "", y = "Sentiment Score", fill = "Pre & Post Roe") +
  facet_grid(~roe_status) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


{r}
#| label: sentiment-over-time

article_sentiment_time <- article_sentiment |>
  group_by(date = floor_date(pub_date, "month")) |>
  summarise(mean_sentiment = mean(sentiment_score, na.rm = TRUE))

ggplot(article_sentiment_time, aes(x = date, y = mean_sentiment)) +
  geom_line(color = "#003f5c") +
  geom_smooth(method = "loess", se = FALSE, color = "black") +
  labs(title = "Average NYT Article Sentiment Over Time", x = "Month", y = "Mean Sentiment Score")


{r}
#| label: roe-articles

roe_articles <- nyt_meta3 |> 
  filter(str_detect(text_clean, "roe|wade|supreme|court|overturn|decision")) |>
  mutate(topic = "Roe v. Wade")

roe_sentiment <- roe_articles |> 
  unnest_tokens(word, text_clean) |> 
  filter(!word %in% all_stops$word) |> 
  left_join(afinn, by = "word") |> 
  group_by(title, pub_date) |> 
  summarise(sentiment_score = sum(value, na.rm = TRUE), .groups = "drop")

roe_sentiment_monthly <- roe_sentiment |> 
  mutate(month = floor_date(pub_date, "month")) |> 
  group_by(month) |> 
  summarise(mean_sentiment = mean(sentiment_score, na.rm = TRUE))

ggplot(roe_sentiment_monthly, aes(x = month, y = mean_sentiment)) +
  geom_line(color = "#003f5c") +
  geom_point(size = 2) +
    geom_vline(xintercept = as.Date("2022-06-24"), 
             color = "red", linetype = "dashed", size = 1) +
    annotate("text", x = as.Date("2022-06-24"), 
           y = max(roe_sentiment_monthly$mean_sentiment, na.rm = TRUE) + 5,
           label = "Dobbs Decision", color = "black", angle = 0, vjust = 1.0, hjust = -0.1) +
   geom_vline(xintercept = as.Date("2021-11-01"), 
             color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = as.Date("2021-11-01"), y = -40, label = "Dobbs arguments heard\nby Supreme Court",
         color = "black", hjust = 1.1,  vjust = 1.0) +
  labs(title = "NYT Sentiment Around Roe v. Wade Overturning", 
       x = "Year", y = "Average Sentiment Score") +
  theme_minimal()



{r}
#| label: wordcloud-by-sentiment-polarity

library(wordcloud2)

#negative sentiment words
nyt_sentiment |> 
  filter(value < 0) |>
  count(word, sort = TRUE) |>
  slice_max(n, n = 50) |>
wordcloud2(size = 0.7, color = "random-dark", backgroundColor = "white")

#positive sentiment words 
nyt_sentiment |> 
  filter(value > 0) |>
  count(word, sort = TRUE) |>
  slice_max(n, n = 50) |>
wordcloud2(size = 0.7, color = "random-dark", backgroundColor = "white")


{r}
#| label: top-sentiment-words
nyt_sentiment |>
  count(word, value, sort = TRUE) |>
  filter(!is.na(value)) |>
  group_by(sign = ifelse(value > 0, "positive", "negative")) |>
  slice_max(n, n = 10) |>
  ungroup() |>
  ggplot(aes(x = n, y = reorder(word, n), fill = sign)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sign, scales = "free_y") +
  labs(title = "Top Sentiment Words in NYT Coverage", x = "Count", y = "Word")


{r}
#| label: animated-racing-chart

install.packages("gganimate")
install.packages("gifski") 

library(gganimate)

# Tokenize bigrams and attach date
bigram_formatted <- nyt_meta3 |>
  unnest_tokens(bigram, text_clean, token = "ngrams", n = 2) |>
  separate(bigram, into = c("word1", "word2"), sep = " ") |>
  filter(!word1 %in% all_stops$word,
         !word2 %in% all_stops$word) |>
  unite(bigram, word1, word2, sep = " ") |>
  mutate(month = floor_date(pub_date, "month")) |>
  count(month, bigram, sort = TRUE) |>
  group_by(month) |>
  slice_max(n, n = 10, with_ties = FALSE) |>  # Top 10 bigrams per month
  mutate(rank = rank(-n, ties.method = "first"),
         Value_lbl = as.character(n)) |>
  ungroup()


# Step 2: Create the static plot template
staticplot <- ggplot(bigram_formatted,
                     aes(rank, group = bigram,
                         fill = as.factor(bigram), color = as.factor(bigram))) +
  geom_tile(aes(y = n / 2, height = n, width = 0.9), alpha = 0.8, color = NA) +
  geom_text(aes(y = 0, label = paste(bigram, " ")), hjust = 1, color = "black") +
  geom_text(aes(y = n, label = Value_lbl), hjust = 0, color = "black") +
  coord_flip(clip = "off", expand = FALSE) +
  scale_x_reverse() +
  guides(color = FALSE, fill = FALSE) +
  theme_minimal(base_size = 15) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(size = 24, face = "bold", hjust = 0.5, color = "gray20"),
    plot.subtitle = element_text(size = 18, face = "italic", hjust = 0.5, color = "gray40"),
    plot.caption = element_text(size = 10, face = "italic", hjust = 0.5, color = "gray40"),
    plot.margin = margin(2, 2, 2, 4, "cm")
  ) +
  labs(title = "Top Bigrams in NYT Articles",
       subtitle = 'Month: {closest_state}',
       caption = "Data from NYT Roe Coverage",
       x = "", y = "")


animate(animated_barchart, fps = 10, duration = 40, width = 800, height = 600)


